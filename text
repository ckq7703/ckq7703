from pymodbus.server.sync import StartTcpServer
from pymodbus.device import ModbusDeviceIdentification
from pymodbus.datastore import ModbusSlaveContext, ModbusServerContext
from pymodbus.datastore import ModbusSequentialDataBlock
import logging

# Tạo log để theo dõi hoạt động
logging.basicConfig()
log = logging.getLogger()
log.setLevel(logging.INFO)

# Tạo Modbus Slave Data Store, với 100 vị trí holding registers
store = ModbusSlaveContext(
    di=ModbusSequentialDataBlock(0, [0]*100),
    co=ModbusSequentialDataBlock(0, [0]*100),
    hr=ModbusSequentialDataBlock(0, [0]*100),
    ir=ModbusSequentialDataBlock(0, [0]*100))

# Tạo ngữ cảnh Server
context = ModbusServerContext(slaves=store, single=True)

# Thông tin về Server
identity = ModbusDeviceIdentification()
identity.VendorName = 'SCADA-System'
identity.ProductCode = 'ModbusServer'
identity.VendorUrl = 'http://scada.local'
identity.ProductName = 'SCADA Modbus Server'
identity.ModelName = 'Modbus Server'
identity.MajorMinorRevision = '1.0'

# Hàm cập nhật dữ liệu khi client ghi vào server
def updating_writer(a):
    context = a[0]
    register = 1  # Thanh ghi số 1 (Holding Register)
    slave_id = 0x00  # Mã slave
    values = context[slave_id].getValues(register, 1)
    log.info(f"Received data from client: {values}")

# In dữ liệu nhận được từ client mỗi 5 giây
from threading import Timer

def update_data():
    context = store.getValues(3, 1, count=10)
    print(f"Dữ liệu hiện tại trên server: {context}")
    Timer(5.0, update_data).start()

# Bắt đầu lắng nghe
if __name__ == "__main__":
    # Khởi động server Modbus
    print("Modbus Server is starting...")

    # Hàm định kỳ kiểm tra dữ liệu
    update_data()

    # Khởi động server TCP với IP và Port
    StartTcpServer(context, identity=identity, address=("172.168.1.11", 502))


---------------------------------
from pymodbus.client.sync import ModbusTcpClient
import time

# Địa chỉ IP của Modbus Server (Kali-A0)
SERVER_IP = '172.168.1.11'
SERVER_PORT = 502

# Khởi tạo Client kết nối đến Modbus Server
client = ModbusTcpClient(SERVER_IP, port=SERVER_PORT)

# Hàm gửi dữ liệu với số thứ tự
def send_data(counter):
    # Nội dung dữ liệu gửi đi
    data = f'Dữ liệu được gửi từ hệ thống SCADA #{counter}'
    
    # Mã hóa dữ liệu thành chuỗi giá trị 16-bit để gửi qua Modbus (holding registers)
    register_values = [ord(char) for char in data]  # Mỗi ký tự thành mã ASCII
    
    # Gửi dữ liệu qua Modbus (ghi vào holding registers từ vị trí 1)
    client.write_registers(1, register_values)
    print(f'Đã gửi: {data}')

# Vòng lặp gửi dữ liệu nhiều lần
counter = 1
while True:
    send_data(counter)
    counter += 1
    time.sleep(5)  # Gửi dữ liệu mỗi 5 giây
